<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agent Graph Studio — v2</title>
    <style>
      /* --------------------------------------------------
         DESIGN SYSTEM
      -------------------------------------------------- */
      :root {
        /* Palette */
        --bg: #0a0f1e;
        --bg-elev: #0d162e;
        --panel: #0e1a36;
        --panel-2: #0b1530;
        --border: #1c2a4e;
        --border-soft: #152449;
        --text: #e7eef8;
        --muted: #8fa5c9;
        --muted-2: #6c82ab;

        --accent: #60a5fa; /* sky-400 */
        --accent-2: #3b82f6; /* blue-500 */
        --good: #22c55e;
        --warn: #f59e0b;
        --bad: #ef4444;

        /* Nodes */
        --done: rgba(34, 197, 94, 0.12);
        --running: rgba(59, 130, 246, 0.12);
        --error: rgba(239, 68, 68, 0.12);
        --pending: rgba(148, 163, 184, 0.12);

        /* Sizes */
        --radius: 12px;
        --radius-lg: 16px;
        --sidebar-w: 280px;
        --right-w: 360px;
        --toolbar-h: 52px;
        --node-w: 220px;
        --node-h: 64px;
        --col-gap: 120px;
        --row-gap: 22px;

        /* Shadows */
        --shadow-sm: 0 1px 4px rgba(0, 0, 0, 0.3);
        --shadow-md: 0 10px 30px rgba(0, 0, 0, 0.35);
        --shadow-lg: 0 24px 64px rgba(0, 0, 0, 0.45);
      }

      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
        margin: 0;
      }
      body {
        background: radial-gradient(
            1200px 800px at 10% -10%,
            #0f1a36 20%,
            #0a0f1e 60%
          ),
          radial-gradient(1200px 800px at 110% 10%, #0e1d3d 10%, #0a0f1e 60%);
        color: var(--text);
        font: 13px/1.45 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI,
          Roboto, Helvetica, Arial, 'Apple Color Emoji', 'Segoe UI Emoji';
        -webkit-font-smoothing: antialiased;
      }

      /* --------------------------------------------------
         APP SHELL
      -------------------------------------------------- */
      .shell {
        display: grid;
        grid-template-rows: var(--toolbar-h) 1fr;
        grid-template-columns: var(--sidebar-w) 1fr;
        grid-template-areas:
          'top top'
          'side main';
        height: 100vh;
      }

      /* TOP BAR */
      .topbar {
        grid-area: top;
        display: grid;
        grid-template-columns: auto 1fr auto auto;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        background: linear-gradient(
          180deg,
          rgba(14, 26, 54, 0.9),
          rgba(14, 26, 54, 0.7)
        );
        border-bottom: 1px solid var(--border);
        backdrop-filter: blur(8px);
        position: sticky;
        top: 0;
        z-index: 50;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        padding-right: 10px;
        border-right: 1px dashed var(--border);
      }
      .logo {
        width: 22px;
        height: 22px;
        border-radius: 7px;
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.12);
      }
      .brand .title {
        font-weight: 800;
        letter-spacing: 0.3px;
      }

      .searchrow {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .input,
      .select,
      .btn {
        border: 1px solid var(--border);
        background: var(--panel-2);
        color: var(--text);
        padding: 8px 10px;
        border-radius: 10px;
        font-size: 13px;
        outline: none;
      }
      .input:focus,
      .select:focus {
        border-color: #2d3d66;
        box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.12);
      }
      .btn {
        cursor: pointer;
        transition: transform 0.06s ease, background 0.2s ease;
      }
      .btn:hover {
        background: #15244b;
      }
      .btn.primary {
        background: linear-gradient(180deg, #3b82f6, #2563eb);
        border-color: #1d4ed8;
      }
      .btn.primary:hover {
        filter: brightness(1.05);
      }

      .top-controls {
        display: flex;
        gap: 8px;
      }
      .status {
        justify-self: end;
        color: var(--muted);
        font-weight: 600;
        letter-spacing: 0.2px;
      }

      /* SIDEBAR */
      .sidebar {
        grid-area: side;
        height: calc(100vh - var(--toolbar-h));
        background: linear-gradient(
          180deg,
          rgba(13, 22, 46, 0.9),
          rgba(13, 22, 46, 0.6)
        );
        border-right: 1px solid var(--border);
        display: grid;
        grid-template-rows: auto 1fr auto;
      }
      .side-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        padding: 10px;
        border-bottom: 1px solid var(--border);
      }
      .tabs {
        display: flex;
        gap: 6px;
      }
      .tab {
        padding: 6px 10px;
        border: 1px solid var(--border);
        border-radius: 999px;
        color: var(--muted);
        cursor: pointer;
        background: var(--panel-2);
      }
      .tab.active {
        color: #cfe0ff;
        border-color: #2a4785;
        background: #0e1a36;
      }

      .side-content {
        overflow: auto;
        padding: 8px;
      }
      .list {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .list-item {
        padding: 8px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: var(--panel-2);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .list-item .meta {
        color: var(--muted);
        font-size: 12px;
      }

      .side-footer {
        padding: 10px;
        border-top: 1px solid var(--border);
        display: flex;
        gap: 8px;
      }

      /* MAIN */
      .main {
        grid-area: main;
        position: relative;
        overflow: hidden;
        background: radial-gradient(
              circle at 1px 1px,
              rgba(53, 69, 103, 0.55) 1px,
              transparent 0
            )
            0 0/18px 18px,
          radial-gradient(
              circle at 1px 1px,
              rgba(53, 69, 103, 0.25) 1px,
              transparent 0
            )
            9px 9px/18px 18px;
      }

      /* CANVAS */
      .canvas-toolbar {
        position: absolute;
        top: 12px;
        left: 12px;
        display: flex;
        gap: 6px;
        z-index: 30;
      }
      .icon-btn {
        width: 36px;
        height: 36px;
        display: grid;
        place-items: center;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: var(--panel-2);
        color: var(--text);
        cursor: pointer;
      }
      .icon-btn:hover {
        background: #15254b;
      }

      .viewport {
        position: absolute;
        inset: 0;
        transform-origin: 0 0;
        will-change: transform;
      }
      .layers {
        position: absolute;
        inset: 0;
      }
      svg.edges {
        position: absolute;
        inset: 0;
        pointer-events: none;
      }
      .nodes {
        position: absolute;
        inset: 0;
      }

      /* MINIMAP */
      .minimap {
        position: absolute;
        right: 14px;
        bottom: 14px;
        width: 200px;
        height: 120px;
        z-index: 25;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: #0a1328;
        box-shadow: var(--shadow-sm);
        overflow: hidden;
        opacity: 0.92;
      }
      .minimap svg {
        width: 100%;
        height: 100%;
        display: block;
      }

      /* Node density when zoomed out */
      body.zoomed-out .node .desc,
      body.zoomed-out .node .tools,
      body.zoomed-out .node .badge {
        display: none;
      }
      body.zoomed-out .node {
        min-height: 44px;
      }

      /* NODE CARD */
      .node {
        position: absolute;
        width: var(--node-w);
        min-height: var(--node-h);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.02),
          rgba(255, 255, 255, 0)
        );
        box-shadow: var(--shadow-sm);
        padding: 8px 10px;
        cursor: pointer;
        user-select: none;
        transition: border-color 0.2s ease, transform 0.12s ease,
          box-shadow 0.2s ease, background 0.2s ease;
      }
      .node:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
        border-color: #2a3b63;
      }
      .node.root {
        border: 1px dashed #27406f;
        background: linear-gradient(
          180deg,
          rgba(59, 130, 246, 0.06),
          transparent
        );
      }
      .node.done {
        background: linear-gradient(
          180deg,
          var(--done),
          rgba(255, 255, 255, 0.02)
        );
      }
      .node.running {
        background: linear-gradient(
          180deg,
          var(--running),
          rgba(255, 255, 255, 0.02)
        );
      }
      .node.error {
        background: linear-gradient(
          180deg,
          var(--error),
          rgba(255, 255, 255, 0.02)
        );
      }
      .node.pending {
        background: linear-gradient(
          180deg,
          var(--pending),
          rgba(255, 255, 255, 0.02)
        );
      }

      .row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
      }
      .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--muted-2);
        flex: 0 0 auto;
      }
      .node.done .dot {
        background: var(--good);
      }
      .node.running .dot {
        background: var(--accent-2);
      }
      .node.error .dot {
        background: var(--bad);
      }

      .title {
        font-weight: 700;
        font-size: 12.5px;
        letter-spacing: 0.2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1 1 auto;
      }
      .badge {
        font-size: 10.5px;
        line-height: 1;
        padding: 4px 6px;
        border-radius: 999px;
        border: 1px solid #23345a;
        background: #0a142c;
        color: #a3b6d8;
      }
      .desc {
        color: #c8d4ea;
        font-size: 11.8px;
        line-height: 1.35;
        max-height: 76px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: pre-wrap;
      }

      .tools {
        margin-top: 6px;
        padding-top: 6px;
        border-top: 1px dashed #263a64;
        display: grid;
        gap: 4px;
      }
      .tool {
        background: #0a142c;
        border-radius: 10px;
        padding: 6px 8px;
        border: 1px solid #23345a;
        font-size: 11.2px;
      }
      .tool-name {
        font-weight: 700;
        color: var(--accent);
        margin-bottom: 2px;
      }
      .tool-result {
        color: #b7c6e4;
        max-height: 70px;
        overflow: hidden;
        white-space: pre-wrap;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          'Liberation Mono', monospace;
        font-size: 11px;
      }

      .node.expanded {
        width: 380px;
        min-height: 200px;
        z-index: 6;
        box-shadow: var(--shadow-lg);
        border-color: #35508b;
        transform: translateY(-1px);
      }
      .node.expanded .tool-result {
        max-height: none;
      }

      /* RIGHT DRAWER — NODE INSPECTOR */
      .drawer {
        position: absolute;
        top: 12px;
        right: 12px;
        width: var(--right-w);
        max-height: calc(100% - 24px);
        background: rgba(10, 18, 37, 0.96);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        display: flex;
        flex-direction: column;
        z-index: 40;
        backdrop-filter: blur(10px);
        overflow: hidden;
      }
      .drawer.hidden {
        display: none;
      }
      .drawer-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
        background: #0e1730;
        color: #cfe0ff;
        font-weight: 700;
        letter-spacing: 0.2px;
      }
      .drawer-body {
        padding: 12px;
        overflow: auto;
        background: #0b1328;
        font-size: 12.5px;
        line-height: 1.5;
        color: #dfe9ff;
        white-space: pre-wrap;
      }

      /* BOTTOM DRAWER — FINAL ANSWER */
      .bottom {
        position: absolute;
        left: 12px;
        right: 12px;
        bottom: 12px;
        max-height: 36vh;
        background: rgba(10, 18, 37, 0.96);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        display: flex;
        flex-direction: column;
        backdrop-filter: blur(10px);
        overflow: hidden;
        z-index: 35;
      }
      .bottom-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
        background: #0e1730;
        font-weight: 700;
        color: #cfe0ff;
      }
      .bottom-body {
        padding: 12px;
        overflow: auto;
        background: #0b1328;
        font-size: 13px;
        color: #dfe9ff;
        white-space: pre-wrap;
      }

      /* COMMAND PALETTE (Ctrl/Cmd + K) */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.55);
        display: none;
        place-items: center;
        z-index: 100;
      }
      .modal {
        width: min(720px, 92vw);
        background: #0d1732;
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: var(--shadow-lg);
        overflow: hidden;
      }
      .modal-header {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .modal-header input {
        flex: 1;
      }
      .modal-body {
        padding: 10px;
        display: grid;
        gap: 6px;
        max-height: 60vh;
        overflow: auto;
      }
      .cmd {
        padding: 10px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: var(--panel-2);
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
      }
      .cmd:hover {
        border-color: #365392;
        background: #101e42;
      }

      /* TOAST */
      .toast {
        position: fixed;
        right: 14px;
        top: 14px;
        display: grid;
        gap: 8px;
        z-index: 120;
      }
      .toast .t {
        background: #0e1a36;
        border: 1px solid var(--border);
        border-left: 3px solid var(--accent-2);
        border-radius: 10px;
        padding: 10px 12px;
        box-shadow: var(--shadow-md);
      }

      /* Small helper */
      .kbd {
        font-family: ui-monospace, Menlo, Consolas, monospace;
        padding: 2px 6px;
        border: 1px solid var(--border);
        border-bottom-width: 2px;
        border-radius: 6px;
        background: #0b1328;
        font-size: 11.5px;
        color: #b9c8e5;
      }

      @media (prefers-reduced-motion: reduce) {
        .node,
        svg.edges path {
          transition: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <!-- TOPBAR -->
      <header class="topbar">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div class="title">Agent Graph Studio</div>
        </div>

        <div class="searchrow">
          <input
            id="query"
            class="input"
            placeholder="Ask anything… (⇧⏎ to run)"
          />
          <button id="runBtn" class="btn primary">Run</button>
          <select id="runMode" class="select" title="Run mode">
            <option value="default">Default</option>
            <option value="fast">Fast</option>
            <option value="trace">With Trace</option>
          </select>
        </div>

        <div class="top-controls">
          <button id="fitBtn" class="btn" title="Fit to content">Fit</button>
          <button id="zoomInBtn" class="btn" title="Zoom in">＋</button>
          <button id="zoomOutBtn" class="btn" title="Zoom out">－</button>
        </div>

        <div class="status" id="status">Ready.</div>
      </header>

      <!-- SIDEBAR -->
      <aside class="sidebar">
        <div class="side-header">
          <div class="tabs">
            <button class="tab active" data-tab="history">Runs</button>
            <button class="tab" data-tab="nodes">Nodes</button>
            <button class="tab" data-tab="settings">Settings</button>
          </div>
          <button
            id="openPalette"
            class="btn"
            title="Command palette (Ctrl/Cmd + K)"
          >
            ⌘K
          </button>
        </div>
        <div class="side-content" id="tab-history">
          <div class="list" id="runHistory"></div>
        </div>
        <div class="side-content" id="tab-nodes" style="display: none">
          <div class="list" id="nodeList"></div>
        </div>
        <div class="side-content" id="tab-settings" style="display: none">
          <div class="list">
            <div class="list-item">
              <div>
                <div style="font-weight: 700">API Base</div>
                <div class="meta">Change your backend URL</div>
              </div>
              <input
                id="apiBase"
                class="input"
                value="http://localhost:8000"
                style="width: 220px"
              />
            </div>
            <div class="list-item">
              <div>
                <div style="font-weight: 700">Shortcuts</div>
                <div class="meta">
                  ⇧⏎ run • ⌘/Ctrl + K palette • ⌘/Ctrl + +/- zoom
                </div>
              </div>
              <span class="kbd">?</span>
            </div>
          </div>
        </div>
        <div class="side-footer">
          <button id="newRunBtn" class="btn">New Run</button>
          <button id="clearBtn" class="btn">Clear</button>
        </div>
      </aside>

      <!-- MAIN / CANVAS -->
      <main class="main">
        <div class="canvas-toolbar">
          <button id="hudFit" class="icon-btn" title="Fit">⌗</button>
          <button id="hudZoomIn" class="icon-btn" title="Zoom in">＋</button>
          <button id="hudZoomOut" class="icon-btn" title="Zoom out">－</button>
        </div>
        <div class="minimap"><svg id="minimap" viewBox="0 0 100 60"></svg></div>
        <div id="viewport" class="viewport">
          <div class="layers">
            <svg
              id="edges"
              class="edges"
              xmlns="http://www.w3.org/2000/svg"
            ></svg>
            <div id="nodesLayer" class="nodes"></div>
          </div>
        </div>

        <!-- RIGHT DRAWER: NODE INSPECTOR (replaces old floating panel) -->
        <aside id="nodePanel" class="drawer hidden" aria-hidden="true">
          <div class="drawer-header">
            <span id="nodePanelTitle">Node details</span>
            <div style="display: flex; gap: 8px; align-items: center">
              <span class="kbd">Esc</span>
              <button id="closeNode" class="btn">Close</button>
            </div>
          </div>
          <pre id="nodeContent" class="drawer-body"></pre>
        </aside>

        <!-- BOTTOM DRAWER: FINAL ANSWER (more readable than tiny panel) -->
        <section class="bottom" id="finalDrawer">
          <div class="bottom-header">Final Answer</div>
          <pre id="finalContent" class="bottom-body">No answer yet.</pre>
        </section>
      </main>
    </div>

    <!-- COMMAND PALETTE MODAL -->
    <div id="palette" class="modal-overlay">
      <div
        class="modal"
        role="dialog"
        aria-modal="true"
        aria-label="Command palette"
      >
        <div class="modal-header">
          <input
            id="paletteSearch"
            class="input"
            placeholder="Type a command…"
          />
          <span class="kbd">Esc</span>
        </div>
        <div class="modal-body" id="paletteList">
          <div class="cmd" data-action="newRun">
            <span>New run</span><span class="kbd">N</span>
          </div>
          <div class="cmd" data-action="fit">
            <span>Fit to content</span><span class="kbd">F</span>
          </div>
          <div class="cmd" data-action="zoomIn">
            <span>Zoom in</span><span class="kbd">+</span>
          </div>
          <div class="cmd" data-action="zoomOut">
            <span>Zoom out</span><span class="kbd">-</span>
          </div>
          <div class="cmd" data-action="clear">
            <span>Clear canvas</span><span class="kbd">⌫</span>
          </div>
          <div class="cmd" data-action="settings">
            <span>Open settings</span><span class="kbd">,</span>
          </div>
        </div>
      </div>
    </div>

    <!-- TOASTS -->
    <div class="toast" id="toast"></div>

    <script>
      // ========= Small utilities =========
      const NODE_W =
        parseInt(
          getComputedStyle(document.documentElement).getPropertyValue(
            '--node-w'
          )
        ) || 220;
      const NODE_H =
        parseInt(
          getComputedStyle(document.documentElement).getPropertyValue(
            '--node-h'
          )
        ) || 64;
      const COL_GAP =
        parseInt(
          getComputedStyle(document.documentElement).getPropertyValue(
            '--col-gap'
          )
        ) || 120;
      const ROW_GAP =
        parseInt(
          getComputedStyle(document.documentElement).getPropertyValue(
            '--row-gap'
          )
        ) || 22;

      const viewport = document.getElementById('viewport');
      const nodesLayer = document.getElementById('nodesLayer');
      const edgesSvg = document.getElementById('edges');
      const minimapSvg = document.getElementById('minimap');
      const runBtn = document.getElementById('runBtn');
      const statusEl = document.getElementById('status');
      const apiBaseEl = document.getElementById('apiBase');
      const queryEl = document.getElementById('query');
      const finalContent = document.getElementById('finalContent');
      const nodePanel = document.getElementById('nodePanel');
      const nodePanelTitle = document.getElementById('nodePanelTitle');
      const nodeContent = document.getElementById('nodeContent');
      const closeNode = document.getElementById('closeNode');
      const fitBtn = document.getElementById('fitBtn');
      const zoomInBtn = document.getElementById('zoomInBtn');
      const zoomOutBtn = document.getElementById('zoomOutBtn');
      const hudFit = document.getElementById('hudFit');
      const hudZoomIn = document.getElementById('hudZoomIn');
      const hudZoomOut = document.getElementById('hudZoomOut');
      const runHistoryEl = document.getElementById('runHistory');
      const nodeListEl = document.getElementById('nodeList');

      // Tabs
      const tabs = document.querySelectorAll('.tab');
      const tabPanels = {
        history: document.getElementById('tab-history'),
        nodes: document.getElementById('tab-nodes'),
        settings: document.getElementById('tab-settings'),
      };
      tabs.forEach((t) =>
        t.addEventListener('click', () => {
          tabs.forEach((x) => x.classList.remove('active'));
          t.classList.add('active');
          for (const [k, el] of Object.entries(tabPanels)) {
            el.style.display = t.dataset.tab === k ? 'block' : 'none';
          }
        })
      );

      // Toast
      const toast = (msg) => {
        const box = document.getElementById('toast');
        const el = document.createElement('div');
        el.className = 't';
        el.textContent = msg;
        box.appendChild(el);
        setTimeout(() => {
          el.remove();
        }, 3000);
      };

      // Pan/Zoom
      let scale = 1,
        origin = { x: 40, y: 60 },
        isPanning = false,
        panStart = { x: 0, y: 0 };
      function applyZoomDensity() {
        document.body.classList.toggle('zoomed-out', scale < 0.9);
        drawMinimapFrame();
      }
      function updateTransform() {
        viewport.style.transform = `translate(${origin.x}px,${origin.y}px) scale(${scale})`;
        applyZoomDensity();
      }
      function setScale(next, cx, cy) {
        const prev = scale;
        scale = Math.min(2.75, Math.max(0.4, next));
        if (cx != null && cy != null) {
          const rect = viewport.getBoundingClientRect();
          const x = cx - rect.left,
            y = cy - rect.top;
          origin.x = x - (x - origin.x) * (scale / prev);
          origin.y = y - (y - origin.y) * (scale / prev);
        }
        updateTransform();
      }
      function zoomIn() {
        setScale(scale * 1.15, window.innerWidth / 2, window.innerHeight / 2);
      }
      function zoomOut() {
        setScale(scale / 1.15, window.innerWidth / 2, window.innerHeight / 2);
      }
      function fitToContent() {
        const box = edgesSvg.getBBox
          ? edgesSvg.getBBox()
          : { x: 0, y: 0, width: 1000, height: 600 };
        const pad = 80;
        const vw = window.innerWidth - pad * 2 - 320;
        const vh = window.innerHeight - pad * 2 - 160;
        const sx = vw / (box.width + pad * 2);
        const sy = vh / (box.height + pad * 2);
        const s = Math.max(0.45, Math.min(2.0, Math.min(sx, sy)));
        scale = s;
        origin = { x: pad - box.x * s + 10, y: 80 + pad - box.y * s };
        updateTransform();
        drawMinimapFrame();
      }

      viewport.addEventListener('mousedown', (e) => {
        if (e.target.classList.contains('node')) return; // drag only empty space
        isPanning = true;
        panStart = { x: e.clientX - origin.x, y: e.clientY - origin.y };
      });
      window.addEventListener('mousemove', (e) => {
        if (!isPanning) return;
        origin.x = e.clientX - panStart.x;
        origin.y = e.clientY - panStart.y;
        updateTransform();
      });
      window.addEventListener('mouseup', () => (isPanning = false));
      window.addEventListener(
        'wheel',
        (e) => {
          if (!e.ctrlKey) return;
          e.preventDefault();
          const next = scale * (e.deltaY > 0 ? 0.9 : 1.1);
          setScale(next, e.clientX, e.clientY);
        },
        { passive: false }
      );

      zoomInBtn?.addEventListener('click', zoomIn);
      zoomOutBtn?.addEventListener('click', zoomOut);
      fitBtn?.addEventListener('click', fitToContent);
      hudZoomIn?.addEventListener('click', zoomIn);
      hudZoomOut?.addEventListener('click', zoomOut);
      hudFit?.addEventListener('click', fitToContent);

      window.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === '+') {
          e.preventDefault();
          zoomIn();
        }
        if ((e.metaKey || e.ctrlKey) && e.key === '-') {
          e.preventDefault();
          zoomOut();
        }
        if (e.key === 'f' && (e.metaKey || e.ctrlKey)) {
          e.preventDefault();
          fitToContent();
        }
        if (e.key === 'Escape') {
          closeInspector();
          closePalette();
        }
        if (e.key === 'Enter' && e.shiftKey) {
          e.preventDefault();
          runAgent();
        }
        if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'k') {
          e.preventDefault();
          openPalette();
        }
      });

      function escHTML(s) {
        return String(s)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
      }
      function pretty(obj) {
        try {
          return JSON.stringify(obj, null, 2);
        } catch {
          return String(obj);
        }
      }
      function shortText(obj, max = 120) {
        const s = typeof obj === 'string' ? obj : pretty(obj);
        return s.length > max ? s.slice(0, max) + '…' : s;
      }
      function safeToolText(v, max = 220) {
        try {
          if (typeof v === 'object' && v !== null)
            return escHTML(shortText(JSON.stringify(v, null, 2), max));
          return escHTML(shortText(String(v), max));
        } catch {
          return escHTML(shortText(String(v), max));
        }
      }

      // Layout helpers
      function longestPathRanks(nodes) {
        const memo = {},
          visiting = new Set();
        function rank(id) {
          if (memo[id] != null) return memo[id];
          if (visiting.has(id)) return 0;
          visiting.add(id);
          const n = nodes[id];
          if (!n || !n.depends_on || n.depends_on.length === 0) {
            memo[id] = 0;
            visiting.delete(id);
            return 0;
          }
          let r = 0;
          for (const d of n.depends_on) r = Math.max(r, rank(d) + 1);
          memo[id] = r;
          visiting.delete(id);
          return r;
        }
        const out = {};
        for (const id of Object.keys(nodes)) out[id] = rank(id);
        return out;
      }
      function buildLayout(state) {
        if (!state?.nodes) return { positions: {}, width: 0, height: 0 };
        const ranks = longestPathRanks(state.nodes);
        const layers = {};
        for (const id of Object.keys(state.nodes)) {
          const r = ranks[id] || 0;
          (layers[r] ??= []).push(id);
        }
        for (const k of Object.keys(layers)) layers[k].sort();
        const positions = {},
          cols = Object.keys(layers)
            .map(Number)
            .sort((a, b) => a - b);
        let maxRows = 0;
        for (const r of cols) {
          const ids = layers[r];
          maxRows = Math.max(maxRows, ids.length);
          ids.forEach((id, i) => {
            positions[id] = {
              x: r * (NODE_W + COL_GAP),
              y: i * (NODE_H + ROW_GAP),
            };
          });
        }
        return {
          positions,
          width: cols.length * (NODE_W + COL_GAP) + 400,
          height: maxRows * (NODE_H + ROW_GAP) + 400,
        };
      }
      function withRootRecursive(state, label) {
        const ROOT = '__root__';
        const nodes = {};
        const hasParent = new Set();
        if (!state?.nodes || Object.keys(state.nodes).length === 0) {
          return {
            nodes: {
              [ROOT]: {
                id: ROOT,
                name: label || 'User Request',
                args: {},
                depends_on: [],
                status: 'done',
              },
            },
            final: null,
            __root__: ROOT,
          };
        }
        for (const node of Object.values(state.nodes))
          for (const dep of node.depends_on || []) hasParent.add(dep);
        for (const [id, node] of Object.entries(state.nodes)) {
          const parent = node.parent;
          const deps = new Set(node.depends_on || []);
          if (parent && state.nodes[parent]) {
            deps.add(parent);
            hasParent.add(id);
          } else if (!deps.size && !hasParent.has(id)) deps.add(ROOT);
          nodes[id] = { ...node, depends_on: Array.from(deps) };
        }
        nodes[ROOT] = {
          id: ROOT,
          name: label || 'User Request',
          args: {},
          depends_on: [],
          status: 'done',
        };
        return { ...state, nodes, __root__: ROOT };
      }
      function edgePath(from, to) {
        const x1 = from.x + NODE_W,
          y1 = from.y + NODE_H / 2;
        const x2 = to.x,
          y2 = to.y + NODE_H / 2;
        const dx = Math.max(44, (x2 - x1) * 0.45);
        return `M ${x1} ${y1} C ${x1 + dx} ${y1}, ${
          x2 - dx
        } ${y2}, ${x2} ${y2}`;
      }

      // Minimap
      let lastMinimapData = { nodes: [], size: { width: 1000, height: 600 } };
      function drawMinimap(
        positions = [],
        size = { width: 1000, height: 600 }
      ) {
        lastMinimapData = { nodes: positions, size };
        const svg = minimapSvg;
        while (svg.firstChild) svg.removeChild(svg.firstChild);
        const { width, height } = size;
        const scaleX = 100 / Math.max(width, 1);
        const scaleY = 60 / Math.max(height, 1);
        const bg = document.createElementNS(
          'http://www.w3.org/2000/svg',
          'rect'
        );
        bg.setAttribute('x', '0');
        bg.setAttribute('y', '0');
        bg.setAttribute('width', '100');
        bg.setAttribute('height', '60');
        bg.setAttribute('fill', '#0b1328');
        svg.appendChild(bg);
        for (const p of positions) {
          const r = document.createElementNS(
            'http://www.w3.org/2000/svg',
            'rect'
          );
          r.setAttribute('x', p.x * scaleX);
          r.setAttribute('y', p.y * scaleY);
          r.setAttribute('width', 4);
          r.setAttribute('height', 2.2);
          r.setAttribute('rx', 1);
          r.setAttribute('fill', '#5b82c8');
          r.setAttribute('opacity', '0.9');
          svg.appendChild(r);
        }
        drawMinimapFrame();
      }
      function drawMinimapFrame() {
        const svg = minimapSvg;
        const { nodes, size } = lastMinimapData;
        if (!nodes.length) return;
        const { width, height } = size;
        const scaleX = 100 / Math.max(width, 1);
        const scaleY = 60 / Math.max(height, 1);
        const old = svg.querySelector('#viewframe');
        if (old) svg.removeChild(old);
        const inv = 1 / scale;
        const vw = window.innerWidth * inv;
        const vh = (window.innerHeight - 160) * inv;
        const vx = -origin.x * inv;
        const vy = -origin.y * inv;
        const rect = document.createElementNS(
          'http://www.w3.org/2000/svg',
          'rect'
        );
        rect.setAttribute('id', 'viewframe');
        rect.setAttribute('x', vx * scaleX);
        rect.setAttribute('y', vy * scaleY);
        rect.setAttribute('width', vw * scaleX);
        rect.setAttribute('height', vh * scaleY);
        rect.setAttribute('fill', 'none');
        rect.setAttribute('stroke', '#93c5fd');
        rect.setAttribute('stroke-width', '1');
        rect.setAttribute('opacity', '0.9');
        svg.appendChild(rect);
      }

      // Rendering
      function render(state) {
        if (!state?.nodes || Object.keys(state.nodes).length === 0) {
          statusEl.textContent = 'No nodes to display.';
          nodesLayer.innerHTML = '';
          edgesSvg.innerHTML = '';
          finalContent.textContent = '';
          drawMinimap([], { width: 1000, height: 600 });
          return;
        }
        const label = (queryEl?.value || 'User Request').trim();
        const view = withRootRecursive(state, label);
        const { positions, width, height } = buildLayout(view);

        // Edges
        edgesSvg.innerHTML = '';
        edgesSvg.setAttribute('viewBox', `0 0 ${width} ${height}`);
        edgesSvg.setAttribute('width', width);
        edgesSvg.setAttribute('height', height);
        const defs = document.createElementNS(
          'http://www.w3.org/2000/svg',
          'defs'
        );
        const marker = document.createElementNS(
          'http://www.w3.org/2000/svg',
          'marker'
        );
        marker.setAttribute('id', 'arrow');
        marker.setAttribute('orient', 'auto');
        marker.setAttribute('markerWidth', '10');
        marker.setAttribute('markerHeight', '10');
        marker.setAttribute('refX', '8');
        marker.setAttribute('refY', '3');
        const ap = document.createElementNS(
          'http://www.w3.org/2000/svg',
          'path'
        );
        ap.setAttribute('d', 'M0,0 L8,3 L0,6 z');
        ap.setAttribute('fill', '#5a79b3');
        marker.appendChild(ap);
        defs.appendChild(marker);
        edgesSvg.appendChild(defs);
        const edgeIndex = new Map();
        for (const node of Object.values(view.nodes)) {
          for (const dep of node.depends_on || []) {
            const from = positions[dep],
              to = positions[node.id];
            if (!from || !to) continue;
            const p = document.createElementNS(
              'http://www.w3.org/2000/svg',
              'path'
            );
            p.setAttribute('d', edgePath(from, to));
            p.setAttribute('marker-end', 'url(#arrow)');
            p.setAttribute('fill', 'none');
            p.setAttribute('stroke', '#3d527c');
            p.setAttribute('stroke-width', '1.6');
            p.setAttribute('stroke-dasharray', '5 5');
            p.setAttribute('opacity', '.9');
            edgesSvg.appendChild(p);
            edgeIndex.set(`${node.id}<-${dep}`, p);
          }
        }

        // Nodes
        nodesLayer.innerHTML = '';
        nodeListEl.innerHTML = '';
        for (const [id, n] of Object.entries(view.nodes)) {
          const pos = positions[id] || { x: 0, y: 0 };
          const el = document.createElement('div');
          el.className = `node ${n.status}${
            id === view.__root__ ? ' root' : ''
          }`;
          el.style.left = `${pos.x}px`;
          el.style.top = `${pos.y}px`;
          const badge = `${n.children?.length || 0}·${
            n.tool_calls?.length || 0
          }`;
          const toolsHTML = (n.tool_calls || [])
            .map(
              (t) => `
            <div class="tool">
              <div class="tool-name">🧩 ${escHTML(t.tool_name)}</div>
              <div class="tool-result">${safeToolText(
                t.result ?? '(no result)',
                220
              )}</div>
            </div>`
            )
            .join('');
          el.innerHTML = `
            <div class="row">
              <span class="dot"></span>
              <div class="title" title="${escHTML(
                n.name || 'Untitled'
              )}">${escHTML(n.name || 'Untitled')}</div>
              <span class="badge" title="children·tools">${badge}</span>
            </div>
            <div class="desc">${escHTML(
              n.description || '(aucun résultat)'
            )}</div>
            ${toolsHTML ? `<div class="tools">${toolsHTML}</div>` : ''}
          `;

          // Hover edges
          el.addEventListener('mouseenter', () => {
            for (const dep of n.depends_on || [])
              edgeIndex.get(`${id}<-${dep}`)?.classList.add('active');
          });
          el.addEventListener('mouseleave', () => {
            for (const dep of n.depends_on || [])
              edgeIndex.get(`${id}<-${dep}`)?.classList.remove('active');
          });

          // Click: expand; Shift+Click: open inspector
          el.addEventListener('click', (e) => {
            if (e.shiftKey) {
              openInspector(n);
            } else {
              el.classList.toggle('expanded');
              statusEl.textContent = `Selected: ${n.name} (${n.status})`;
            }
          });

          nodesLayer.appendChild(el);

          // side nodes list (for quick navigation)
          const li = document.createElement('div');
          li.className = 'list-item';
          li.innerHTML = `<span>${escHTML(
            n.name || id
          )}</span><span class="meta">${n.status || ''}</span>`;
          li.addEventListener('click', () => {
            openInspector(n);
          });
          nodeListEl.appendChild(li);
        }

        // Final answer
        if (state.final) {
          const txt =
            typeof state.final === 'string'
              ? state.final
              : state.final.answer ?? pretty(state.final);
          finalContent.textContent = txt;
          statusEl.textContent = 'Done.';
        } else {
          finalContent.textContent = 'No answer yet.';
          statusEl.textContent = 'Ready.';
        }

        drawMinimap(Object.values(positions), { width, height });
        fitToContent();
      }

      // Inspector
      function openInspector(node) {
        nodePanelTitle.textContent = node.name || 'Node details';
        nodeContent.textContent = pretty(node);
        nodePanel.classList.remove('hidden');
        nodePanel.setAttribute('aria-hidden', 'false');
      }
      function closeInspector() {
        nodePanel.classList.add('hidden');
        nodePanel.setAttribute('aria-hidden', 'true');
      }
      closeNode.addEventListener('click', closeInspector);

      // Backend
      async function runAgent() {
        const base = (apiBaseEl?.value || 'http://localhost:8000').replace(
          /\/$/,
          ''
        );
        const query = (queryEl?.value || '').trim();
        const mode = document.getElementById('runMode').value;
        statusEl.textContent = 'Running…';
        toast('Running agent…');
        try {
          const res = await fetch(`${base}/api/agent/run`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query, mode }),
          });
          if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
          const data = await res.json();
          const leaves = data.reasoning_tree?.leaves || data.leaves;
          if (!leaves || Object.keys(leaves).length === 0) {
            statusEl.textContent = 'No leaves returned.';
            toast('No leaves returned.');
            return;
          }

          const nodes = {};
          for (const [leafId, leaf] of Object.entries(leaves)) {
            nodes[leafId] = {
              id: leaf.id,
              name: (leaf.title || leaf.description || 'Untitled').slice(0, 60),
              description: leaf.result || leaf.summary || '(aucun résultat)',
              depends_on: leaf.parent_leaf ? [leaf.parent_leaf] : [],
              status: leaf.status || 'done',
              tool_calls: leaf.tool_calls || [],
              parent: leaf.parent_leaf,
              children: leaf.child_leaves,
            };
          }

          const finalAnswer = Object.values(leaves).find(
            (l) => l.description === 'Réponse finale'
          )?.result;

          // history card
          const card = document.createElement('div');
          card.className = 'list-item';
          card.innerHTML = `<span>${escHTML(
            query || 'Untitled run'
          )}</span><span class="meta">${new Date().toLocaleTimeString()}</span>`;
          runHistoryEl.prepend(card);

          render({
            nodes,
            final: finalAnswer || data.final || null,
            trace: [],
            root: 'leaf_0',
          });
        } catch (e) {
          console.error(e);
          statusEl.textContent = 'Error: ' + (e?.message || e);
          toast('Error: ' + (e?.message || e));
        }
      }

      runBtn.addEventListener('click', runAgent);
      queryEl?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.shiftKey) {
          e.preventDefault();
          runAgent();
        }
      });

      // Palette
      const palette = document.getElementById('palette');
      const paletteSearch = document.getElementById('paletteSearch');
      const paletteList = document.getElementById('paletteList');
      document
        .getElementById('openPalette')
        ?.addEventListener('click', openPalette);
      function openPalette() {
        palette.style.display = 'grid';
        paletteSearch.focus();
      }
      function closePalette() {
        palette.style.display = 'none';
      }
      palette.addEventListener('click', (e) => {
        if (e.target === palette) closePalette();
      });
      paletteList.addEventListener('click', (e) => {
        const el = e.target.closest('.cmd');
        if (!el) return;
        const action = el.dataset.action;
        runAction(action);
        closePalette();
      });
      function runAction(a) {
        const map = {
          newRun: () => {
            queryEl.value = '';
            queryEl.focus();
          },
          fit: fitToContent,
          zoomIn,
          zoomOut,
          clear: clearCanvas,
          settings: () => {
            tabs.forEach((t) => t.classList.remove('active'));
            tabs.forEach((t) => {
              if (t.dataset.tab === 'settings') t.classList.add('active');
            });
            for (const [k, el] of Object.entries(tabPanels))
              el.style.display = k === 'settings' ? 'block' : 'none';
          },
        };
        (map[a] || (() => {}))();
      }

      // Clear canvas
      function clearCanvas() {
        nodesLayer.innerHTML = '';
        edgesSvg.innerHTML = '';
        finalContent.textContent = '';
        toast('Canvas cleared');
      }
      document
        .getElementById('clearBtn')
        .addEventListener('click', clearCanvas);
      document.getElementById('newRunBtn').addEventListener('click', () => {
        queryEl.value = '';
        queryEl.focus();
        toast('New run');
      });

      // Expose for console
      window.AgentGraphUI = { render, runAgent, fitToContent };
    </script>
  </body>
</html>
